<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Introduction to XMLHttpRequest Level 2 - Dev.Opera</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="L7q_7GF5c9d7ZAUYdfaTiRaB6sTAGv_cRz3nq5DsabM">
    <meta name="description" content="Dev.Opera is the ultimate source of distilled knowledge for web developers, covering the latest open web technologies and techniques including HTML5, CSS3, JavaScript, SVG, optimizing content for mobiles, tablets and TVs, and creating add-ons such as extensions and themes for the Opera browser.">
    <meta name="keywords" content="Opera, web, HTML5, HTML, CSS3, CSS, JavaScript, SVG, Geolocation, Widgets, Extensions, Unite, Mini, Mobile, web development, design, web design, tutorials, articles, examples, demos, web standards, open standards, open web, video, audio, getusermedia, accessibility, wai-aria, transitions, translations, microformats, microdata, dataset, media queries, viewport, @viewport, transparency, opacity, gradients, box-shadow, text-shadow, web fonts, appcache, websql, local storage, ajax, json, games, userjs, webgl, tv, tablet, emulator, skinning, themes, skins, drasgonfly, mathml, web sockets, operawatir">
    <link rel="icon" href="../../../../static.myopera.com/dev/img/speed_dial-icon.png" type="image/png">
    <link rel="apple-touch-icon" href="../../../../static.myopera.com/dev/img/touch-icon.png" type="image/png">
    <link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../../../static.myopera.com/dev/css/devopera.css" type="text/css">
    <!--[if IE 6]><link rel="stylesheet" href="/css/browsers/ie6.css" type="text/css"><![endif]-->
    <!--[if IE 7]><link rel="stylesheet" href="/css/browsers/ie7.css" type="text/css"><![endif]-->
    <!--[if IE 8]><link rel="stylesheet" href="/css/browsers/ie8.css" type="text/css"><![endif]-->
    <!--[if lte IE 8]><script type="text/javascript" src="/js/ie.js"></script><![endif]-->
    <link rel="stylesheet" href="../../../../static.myopera.com/dev/css/articles.css">
    <link rel="stylesheet" media="print" href="../../../../static.myopera.com/dev/css/print.css">
    <link rel="stylesheet" href="../../../../static.myopera.com/dev/css/github.css">
    <link rel="alternate" type="application/rss+xml" title="Recent articles - RSS 2.0 Feed" href="../../../feeds/rss/articles">
    <link rel="alternate" type="application/atom+xml" title="Recent articles - Atom 1.0 Feed" href="../../../feeds/atom/articles">
    <link rel="alternate" type="application/rss+xml" title="Recent articles in Web - RSS 2.0 Feed" href="../../../feeds/rss/articles/web">
    <link rel="alternate" type="application/atom+xml" title="Recent articles in Web - Atom 1.0 Feed" href="../../../feeds/atom/articles/web">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="../../../../static.myopera.com/dev/js/menu.js"></script>
    <noscript>
      <style type="text/css">
.collection ul li ul {
    display: inherit !important;
}
      </style>
    </noscript>
    <script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-4118503-4']);
_gaq.push(['_gat._anonymizeIp']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
    </script>

  </head>
  <body class="web">
    <header role="banner"  class="article-view" >
      <div>
        <a href="../../../index.html" id="logo">Dev.Opera</a>
        <form action="http://dev.opera.com/search" role="search">
          <fieldset>
            <label class="hidden" for="q">Search</label>
            <input type="text" name="q" maxlength="256" value="" id="q" required>
            <input type="submit" id="q-submit" value="Search" title="Search">
          </fieldset>
        </form>
        <p id="login">
          <a href="../../../../../https/dev.opera.com/login/index.html" accesskey="L" title="Log in">Log in</a>
        </p>
        <nav id="nav">
          <ul role="menu">

            <li role="menuitem"  class="selected">
              <a href="../../../web.html">Web</a>
            </li>
            <li role="menuitem" >
              <a href="../../../addons.1.html">Add-ons</a>
            </li>
            <li role="menuitem" >
              <a href="../../../mobile.html">Mobile</a>
            </li>
            <li role="menuitem" >
              <a href="../../../tv.html">TV</a>
            </li>
            <li role="menuitem" >
              <a href="../../../labs.html">Labs</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
<section id="content" role="main" class="asideleft">
  <section class="main">
    <article lang="en">
      <h1>Introduction to XMLHttpRequest Level 2</h1>
      <p class="print author">By Tiffany Brown</p>

      <ul>
	<li><a href="index.html#xhrintro">Introduction</a>
	<li><a href="index.html#xhrnew">What&#39;s new in XMLHttpRequest</a></li>
	<li><a href="index.html#xhrtimeouts">Setting and handling timeouts</a></li>
	<li><a href="index.html#crossdomainxhr">Requesting data from another domain</a>
	  <ul>
	    <li>
	      <a href="index.html#cors">An overview of cross-origin resource sharing</a>
	        <ul>
	          <li><a href="index.html#corsorigin">The origin header</a></li>
	          <li><a href="index.html#corsalloworigin">Access-Control-Allow-Origin response header</a></li>
	        </ul>
	      </li>
	    </ul>
	</li>
	<li><a href="index.html#xhrcredentials">Sending user credentials with requests</a></li>
	<li><a href="index.html#formdata">Sending data as key-value pairs with <code>FormData</code> objects</a>
	  <ul>
	    <li><a href="index.html#formdatahtmlform">Using <code>FormData</code> with an HTML form</a></li>
	  </ul>
	</li>
	<li><a href="index.html#xhrprogressevents">Monitoring data transfers with progress events</a>
	  <ul>
	    <li><a href="index.html#xhruploads">Monitoring uploads</a></li>
	  </ul>
	</li>
	<li><a href="index.html#mimeoverride">Enforcing a response MIME type</a></li>
	<li><a href="index.html#xhrresponsetype">Enforcing a response type</a></li>
	<li><a href="index.html#conclusion">Learn more</a></li>
</li></ul>

<h2 id="xhrintro">Introduction</h2>

<p><code>XMLHttpRequest</code> allows developers to make <abbr title="hyper text transfer protocol">HTTP</abbr> and <abbr title="hyper text transfer protocol - secure">HTTPS</abbr> requests and modify the current page without reloading it. Submitting forms and retrieving additional content are two common uses.</p>

<p>Early forms of <code>XMLHttpRequest</code> limited requests to text, HTML and XML. Sending variables and values required syntax &#8212; URL-encoded strings &#8212; that were messy to read and write.</p>

<p>Early XHR was also subject to a <a href="http://www.w3.org/Security/wiki/Same_Origin_Policy" target="blank">same-origin policy</a>, that made cross-domain requests more difficult. You couldn&#39;t, for instance, share data between <em>http://foo.example/</em> and <em>http://bar.example/</em> without an intermediary such as <a href="http://flxhr.flensed.com/">Flash-enabled XHR</a> or a <a href="http://developer.yahoo.com/javascript/howto-proxy.html">proxy server</a>. Sharing data between subdomains (e.g. <em>http://foo.example</em> and <em>http://www.foo.example</em>) required setting a <code>document.domain</code> in scripts on both origins. Doing so, however carried <a href="http://code.google.com/p/browsersec/wiki/Part2#Same-origin_policy_for_DOM_access">security risks</a>. </p>

<p>Uploading files with earlier implementations of XHR? No can do. Instead we had to rely on workarounds such as <a href="http://swfupload.org/">SWFUpload</a>, which required a plugin. Or we had to use a hidden <code>iframe</code>, which lacked client-side progress events.</p>

<p>We can do better than that, and we have. This article looks at <a href="http://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html">improvements to XMLHttpRequest</a>, and the state of support in Opera 12.</p>

<h2 id="xhrnew">What&#39;s new in XMLHttpRequest</h2>

<p>With changes to the XMLHttpRequest specification and improved browser support, you can now:</p>


<ul>
	<li>Set request timeouts</li>
	<li>Better manage data with <a href="index.html#formdata"><code>FormData</code> objects</a></li>
	<li>Transfer binary data</li>
	<li><a href="index.html#xhrprogressevents">Monitor the progress</a> of data transfers</li>
	<li>Make safer <a href="index.html#crossdomainxhr">cross-origin requests</a></li>
	<li>Override the media type and encoding of responses.</li>
</ul>

<h2 id="xhrtimeouts">Setting and handling timeouts</h2>

<p>Sometimes requests are slow to complete. This may be due to high latency in the network or a slow server response. Slow requests will make your application appear unresponsive, which is not good for the user experience.</p>

<p>XHR now provides a way for handling this problem: request timeouts. Using the <code>timeout</code> attribute, we can specify how many milliseconds to wait before the application does something else. In the example that follows, we&apos;ve set a three second (3000 millisecond) timeout:</p>


<pre><code class="javascript">function makeRequest() {
  var url = &#39;data.json&#39;;
  var onLoadHandler = function(event){
     // Parse the JSON and build a list.
  }
  var onTimeOutHandler = function(event){
    var content = document.getElementById(&#39;content&#39;),
      p = document.createElement(&#39;p&#39;),
      msg = document.createTextNode(&#39;Just a little bit longer!&#39;);
      p.appendChild(msg);
      content.appendChild(p);

      // Restarts the request.
      event.target.open(&#39;GET&#39;,url);

      // Optionally, set a longer timeout to override the original.
      event.target.timeout = 6000;
      event.target.send();
  }
  var xhr = new XMLHttpRequest();
  xhr.open(&#39;GET&#39;,url);
  xhr.timeout = 3000;
  xhr.onload = onLoadHandler;
  xhr.ontimeout = onTimeOutHandler;
  xhr.send();
}

window.addEventListener(&#39;DOMContentLoaded&#39;, makeRequest, false);</code></pre>

<p>If more than three seconds pass before response data is received, we&#39;ll notify the user that the request is taking too long. Then we&#39;ll initiate a new request with a longer timeout limit (<a href="../../../../devfiles.myopera.com/articles/9482/xhr-timeout.html">view an XHR timeouts demo</a>). Resetting the timeout limit within the <code>timeout</code> event handler isn&#39;t strictly necessary. We&#39;ve done so for this URL to avoid a loop since its response will always exceed the initial timeout value.</p>

<p>To date, Chrome and Safari do not support XHR timeouts. Opera, Firefox, and Internet Explorer 10 do. Internet Explorer 8 and 9 also support timeouts on the <a href="http://msdn.microsoft.com/en-us/library/dd573303(v=vs.85).aspx"><code>XDomainRequest</code></a> object.</p>

<h2 id="crossdomainxhr">Requesting data from another domain</h2>

<p>One limitation of early <abbr>XHR</abbr> was the <a href="http://www.w3.org/Security/wiki/Same_Origin_Policy">same-origin policy</a>. Both the requesting document and the requested document had to originate from the same scheme, host, and port. A request from <em>http://www.foo.example</em> to <em>http://www.foo.example:5050</em> &#8212; a cross-port request &#8212; would cause a security exception (except in older versions of Internet Explorer, which allowed cross-port requests).</p>

<p>Now XMLHttpRequest supports cross-origin requests, provided <a href="http://dvcs.w3.org/hg/cors/raw-file/tip/Overview.html">cross-origin resource sharing</a> (CORS) is enabled.</p>

<p class="note">Internet Explorer 8 and 9 do not support cross-domain <code>XMLHttpRequest</code>, though IE10 does. Instead, Internet Explorer 8 and 9 use the <code>XDomainRequest</code> object, which works similarly.</p>

<p>Cross-origin requests look just like same-origin requests, but use a full URL instead of a relative one:</p>

<pre><code class="javascript">var xhr = new XMLHttpRequest();
var onLoadHandler = function(event) {
  /* do something with the response */
}
xhr.open(&#39;GET&#39;,&#39;http://other.server/and/path/to/script&#39;);
xhr.onload = onLoadHandler;
xhr.send();</code></pre>

<p>The critical difference is that the target URL must permit access from the requesting origin by sending an <code>Access-Control-Allow-Origin</code> response header.</p>

<h3 id="cors">An overview of cross-origin resource sharing</h3>

<p>For an in-depth look at CORS, read <a href="../dom-access-control-using-cross-origin-resource-sharing/index.html">DOM access control using cross-origin resource sharing</a>. Here we&#39;ll just cover two headers: the <code>Origin</code> request header, and the <code>Access-Control-Allow-Origin</code> response header.</p>

<h4 id="corsorigin">The origin header</h4>

<p>When making a cross-origin XHR request, Opera and other browsers will automatically include an <code>Origin</code> header — see below for an example:</p>

<pre><code class="no-highlight">GET /data.xml HTTP/1.1
User-Agent: Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; en) Presto/2.10.289 Version/12.00
Host: datahost.example
Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/webp, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1
Accept-Language: en,en-US
Accept-Encoding: gzip, deflate
Referer: http://requestingserver.example/path/to/askingdocument.html
Connection: Keep-Alive
Origin: http://requestingserver.example</code></pre>

<p><code>Origin</code> typically contains the scheme, host name, and port of the requesting document. It is not an author request header, meaning it can&#8217;t be set or modified using the <code>setRequestHeader()</code> method; user agents will ignore it if you try. Its entire purpose is to inform the target server about the origins of this request. Bear in mind that there is no trailing slash.</p>

<h4 id="corsalloworigin">The <code>Access-Control-Allow-Origin</code> response header</h4>

<p>The <code>Access-Control-Allow-Origin</code> header is sent by the target server in response to a cross-origin request. It tells the user agent whether access should be granted to the requesting origin. <strong>DOM operations involving a cross-origin XHR request will not be completed unless the requested URL allows it.</strong> An example follows:</p>

<pre><code class="no-highlight">HTTP/1.1 200 OK
Date: Fri, 27 May 2011 21:27:14 GMT
Server: Apache/2
Last-Modified: Fri, 27 May 2011 19:29:00 GMT
Accept-Ranges: bytes
Content-Length: 1830
Keep-Alive: timeout=15, max=97
Connection: Keep-Alive
Content-Type:  application/xml; charset=UTF-8
Access-Control-Allow-Origin: *</code></pre>

<p>In this case, we&#8217;re using a wild card (*) to allow access from <em>any</em> origin. This is fine if you are offering a public-facing <abbr title="Application Programming Interface">API</abbr>. For most other uses, you&#39;ll want to set a more specific origin value.</p>

<h2 id="xhrcredentials">Sending user credentials with cross-domain requests</h2>

<p>There may be occasions when you will want to send cookie data along with your cross-domain request. That&#8217;s where the <code>withCredentials</code> attribute comes in handy. It is a boolean attribute that alerts the browser that it should send <a href="http://www.w3.org/TR/XMLHttpRequest2/#user-credentials">user credentials</a> along with the request. By default, the credentials flag is <code>false</code>. In the code below, let&#8217;s assume that our request is going from <em>http://foo.example</em> to <em>http://other.server</em>:</p>

<pre><code class="javascript">var xhr = new XMLHttpRequest();
var onLoadHandler = function(event) {
  doSomething(event.target.responseText);
}
xhr.open(&#39;GET&#39;,&#39;http://other.server/and/path/to/script&#39;);
xhr.withCredentials = true;
xhr.onload = onLoadHandler;
xhr.send();</code></pre>

<p>In our <a href="../../../../devfiles.myopera.com/articles/9482/xhr-credentials.html">XHR credentials demo</a>, we are using a counter cookie to track the number of visits. If you examine the request and response data (you can do this with Dragonfly&apos; Network panel), you will see that the browser is sending request cookies and receiving response cookies. Our server-side script will return text containing the new visit count, and update the value of the cookie. </p>

<p>Keep the following in mind when making requests with credentials:</p>

<ul>
	<li><code>withCredentials</code> is only necessary for cross-origin requests.</li>
	<li>The <code>Access-Control-Allow-Origin</code> header of the requested URI can not contain a wildcard (*).</li>
	<li>The <code>Access-Control-Allow-Credentials</code> header of the requested URI must be set to <code>true</code>.</li>
	<li>Only a subset of response headers will be available to <code>getAllRequestHeaders()</code>, unless the <code>Access-Control-Expose-Headers</code> header has been set.</li>
</ul>

<p>Same-origin requests will ignore the credentials flag. A wildcard  <code>Access-Control-Allow-Origin</code> header value will cause an exception. If the value of <code>Access-Control-Allow-Credentials</code> is <code>false</code>, <strong>cookies will still be sent and received</strong>, however they will not be available to the DOM.</p>

<h2 id="formdata">Sending data as key-value pairs with <code>FormData</code> objects</h2>

<p>In previous implementations, data sent via XHR had to be submitted as a string, either using URL-encoding, or JSON (with <code>JSON.stringify()</code>). The example below uses URL-encoding:</p>

<pre><code class="javascript">var msg = &#39;field1=foo&amp;field2=bar&#39;;
var xhr = new XMLHttpRequest();
xhr.open(&#39;POST&#39;,&#39;/processing_script&#39;);
xhr.setRequestHeader(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded&quot;);
xhr.send(msg);</code></pre>

<p>Now, we can use the <code>FormData</code> object, and its ordered, key-value pairs. The syntax offers three benefits:</p>

<ul>
	<li>Scripts are more readable</li>
	<li>Data is sent in key-value pairs, as with regular HTML forms</li>
	<li><code>FormData</code> objects are sent with <code>multipart/form-data</code> encoding, making it possible to use XHR for sending binary data.</li>
 </ul>

<p>If you&apos;ve ever worked with <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/net/URLVariables.html"><code>URLVariables</code></a> in ActionScript 3.0, <code>FormData</code> will feel familiar. First create a <code>FormData</code> object, then add data using the <code>append()</code> method. The <code>append()</code> method requires two parameters: <code>key</code> and <code>value</code>. Each <code>FormData</code> key becomes a variable name available to your server-side script. An example follows:</p>

<pre><code class="javascript">var xhr = new XMLHttpRequest();
var dataToSend = new FormData(); // create a new FormData object

xhr.open(&#39;POST&#39;,&#39;/processing_script&#39;);

dataToSend.append(&#39;name&#39;,&#39;Joseph Q. Public&#39;); // add data to the object
dataToSend.append(&#39;age&#39;,&#39;52&#39;);
dataToSend.append(&#39;hobby&#39;,&#39;knitting&#39;);

xhr.send(dataToSend); // send the object</code></pre>

<p>We&#8217;ve passed the <code>FormData</code> object as the argument of the <code>send()</code> method: <code>xhr.send(dataToSend)</code>. We did not set a <code>Content-Type</code> header on our <code>XMLHttpRequest</code> object. Let&#39;s take a look at the request headers sent by Opera:</p>

<pre><code class="no-highlight">POST /processing_script HTTP/1.1
User-Agent: Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8) Presto/2.10.289 Version/12.00
Host: datahost.example
Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/webp, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1
Accept-Language: en,en-US
Accept-Encoding: gzip, deflate
Expect: 100-continue
Referer: http://datahost.example/upload/
Connection: Keep-Alive
Content-Length: 4281507
Content-Type: multipart/form-data; boundary=----------J2GMKTyAkjRjNgFzKv3VBJ</code></pre>

<p>Opera has added the <code>Content-Type</code> header for us because we are using a <code>FormData</code> object. Other browsers do the same.</p>

<h3 id="formdatahtmlform">Using <code>FormData</code> with an HTML form</h3>

<p>You can also send the values from a form with <code>FormData</code>, by passing the form to the <code>FormData</code> object as shown below (<a href="../../../../devfiles.myopera.com/articles/9482/xhr-formdata.html">view an XHR FormData demo</a>).</p>

<pre><code class="javascript">var submitHandler = function(event) {
  var dataToSend = new FormData(event.target), xhr = new XMLHttpRequest();
  xhr.open(&#39;POST&#39;,&#39;/processing_script&#39;);
  xhr.send(dataToSend);
}

var form = document.getElementById(&#39;myform&#39;);

form.addEventListener(&#39;submit&#39;,submitHandler,false);</code></pre>

<p><code>FormData</code> is still untrusted data. Treat input from a <code>FormData</code> object as you would any other kind of form submission.</p>

<h2 id="xhrprogressevents">Monitoring data transfers with progress events</h2>

<p>XMLHttpRequest now provides progress event attributes that allow us to monitor data transfers. Previously, we would listen to the <code>readystatechange</code> event, as in the example below:</p>

<pre><code class="javascript">var xhr = new XMLHttpRequest();
var onReadyStateHandler = function(event) {
  if( event.target.readyState == 4 &amp;&amp; event.target.status == 200){
    /* handle the response */
  }
}
xhr.open(&#39;GET&#39;,&#39;/path_to_data&#39;);
xhr.onreadystatechange = onReadyStateHandler;
xhr.send();</code></pre>

<p>Though it works well for alerting us that all of our data has downloaded, <code>readystatechange</code> doesn&#8217;t tell us anything about how much data has been received. For backward compatibility, it remains a part of the specification. The <a href="http://www.w3.org/TR/progress-events/"><code>ProgressEvent</code> interface</a>, however, is far more robust. It adds seven events that are available to both the <code>XMLHttpRequest</code> and the <code>XMLHttpRequestUpload</code> objects.</p>

<p>The different <code>XMLHttpRequest</code> Progress Events are as follows:</p>

<table>
 	<thead>
		<tr>
		 <th>attribute</th>
		 <th>type</th>
		 <th>Explanation</th>
		</tr>
	<tbody>
	<tr>
	 <td><code>onloadstart</code></td>
	 <td><code title="event-xhr-loadstart">loadstart</code></td>
	 <td>When the request starts.</td>
	</tr>

	<tr>
	 <td><code>onprogress</code></td>
	 <td><code title="event-xhr-progress">progress</code></td>
	 <td>While loading and sending data.</td>
	</tr>

	<tr>
	 <td><code>onabort</code></td>
	 <td><code title="event-xhr-abort">abort</code></td>
	 <td>When the request has been aborted, either by invoking the <code>abort()</code> method or navigating away from the page.</td>
	</tr>

	<tr>
	 <td><code>onerror</code></td>
	 <td><code title="event-xhr-error">error</code></td>
	 <td>When the request has failed.</td>
	</tr>

	<tr>
	 <td><code>onload</code></td>
	 <td><code title="event-xhr-load">load</code></td>
	 <td>When the request has successfully completed.</td>
	</tr>

	<tr>
	 <td><code>ontimeout</code></td>
	 <td><code title="event-xhr-timeout">timeout</code></td>
	 <td>When the author specified timeout has passed before the request could complete.</td>
	</tr>

	<tr>
	 <td><code>onloadend</code></td>
	 <td><code title="event-xhr-loadend">loadend</code></td>
	 <td>When the request has completed, regardless of whether or not it was successful.</td>
	</tr>
	</tbody>
</thead></table>

<p><code>ProgressEvent</code> inherits from the <a href="http://www.w3.org/TR/DOM-Level-2-Events/events.html#Events-EventTarget">DOM, Level 2 <code>EventTarget</code></a> interface so we can either use event attributes such as <code>onload</code>, or the <code>addEventListener</code> method in our code. In the examples above, we&#39;ve used event attributes. In our next example, we&#8217;ll use <code>addEventListener</code>.</p>


<h3 id="xhruploads">Monitoring uploads</h3>

<p>All <code>XMLHttpRequest</code>-based file uploads create an <code>XMLHttpRequestUpload</code> object, which we can reference with the <code>upload</code> attribute of <code>XMLHttpRequest</code>. To monitor upload progress, we&#8217;ll need to listen for events on the <code>XMLHttpRequestUpload</code> object.</p>

<p>In the code below, we&#8217;re listening for the <code>progress</code>, <code>load</code> and <code>error</code> events:</p>

<pre><code class="javascript">var onProgressHandler = function(event) {
  if(event.lengthComputable) {
    var howmuch = (event.loaded / event.total) * 100;
        document.querySelector(&#39;progress&#39;).value = Math.ceil(howmuch);
  } else {
    console.log(&quot;Can&#39;t determine the size of the file.&quot;);
  }
}

var onLoadHandler = function() {
  displayLoadedMessage();
}

var onErrorHandler = function() {
  displayErrorMesssage();
}

xhr.upload.addEventListener(&#39;progress&#39;, onProgressHandler, false);
xhr.upload.addEventListener(&#39;load&#39;, onLoadHandler, false);
xhr.upload.addEventListener(&#39;error&#39;, onErrorHandler, false);</code></pre>


<p>Pay special attention to the <code>lengthComputable</code>, <code>loaded</code> and <code>total</code> properties used in the <code>onProgressHandler</code> function. Each of these are properties of the progress event object. The <code>lengthComputable</code> property reveals whether or not the browser can detect the input file size, while <code>loaded</code> and <code>total</code> reveal how many bytes have been uploaded and the total size of the file. You can <a href="../../../../devfiles.myopera.com/articles/9482/xhr-progressevents.html">view an XHR progress events demo</a>.</p>

<p>These events only monitor the browser&#8217;s progress in sending data to or receiving data from the server. When uploading, you may experience a lag between when the <code>load</code> event is fired and when the server sends a response. How long of a lag will depend on the size of the file, the server&#8217;s resources, and network speeds.</p>

<p>In the example above, we&#8217;re setting event listeners on the <code>XMLHttpRequestUpload</code> object. To monitor file <em>downloads</em>, add event listeners to the <code>XMLHttpRequest</code> object instead.</p>

<h2 id="mimeoverride">Enforcing a response MIME type</h2>

<p>MIME-type mismatches are pretty common on the web. Sometimes XML data will have a <code>Content-type: text/html</code> response header, which will cause the value of <code>xhr.responseXML</code> to be <code>null</code>.</p>

<p>To ensure that the browser handles such responses in the way we&#8217;d like, we can use the <code>overrideMimeType()</code> method. In the example below, <em>data.xml</em> returns the following response headers:</p>

<pre><code class="no-highlight">Date: Sat, 04 Jun 2011 03:11:31 GMT
Server: Apache/2.2.17
Access-Control-Allow-Origin: *
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=UTF-8</code></pre>

<p>That&#8217;s the wrong content type for an XML document. So let&#8217;s guarantee that the browser treats <em>data.xml</em> as XML, and populates the <code>responseXML</code> attribute:</p>

<pre><code class="javascript">var xhr = new XMLHttpRequest();
xhr.open(&#39;GET&#39;,&#39;data.xml&#39;);
xhr.overrideMimeType(&#39;application/xml&#39;);
xhr.send();
xhr.addEventListener(&#39;load&#39;, function(event) {
  console.log( event.target.responseXML );
}, false);</code></pre>

<p>Now the value of <code>xhr.responseXML</code> is a <code>Document</code> object, which means we can parse the data as we would any other XML document. <a href="../../../../devfiles.myopera.com/articles/9482/xhr-overridemimetype.html">View an XHR override MIME type demo</a>.</p>

<h2 id="xhrresponsetype">Enforcing a response type</h2>

<p>It&#39;s also possible to tell the browser to handle a response as <code>text</code>, <code>json</code>,
an <code>arraybuffer</code>, a <code>blob</code> or and <code>document</code> using the <code>responseType</code> property.</p>

<p>As with <code>overrideMimeType</code>, the <code>responseType</code> property must be set before the request is sent. In the example below, we are telling Opera to treat the response as a <code>document</code>, and write the <code>firstChild</code> to the console (<a href="../../../../devfiles.myopera.com/articles/9482/xhr-responsetype.html">view an enforcing response type demo</a>):</p>

<pre><code class="javascript">var xhr = new XMLHttpRequest();
xhr.open(&#39;GET&#39;,&#39;data.xml&#39;);
xhr.responseType = &#39;document&#39;;
xhr.send();

xhr.addEventListener(&#39;load&#39;, function(e) {
  console.log( event.target.response.firstChild );
} false);</code></pre>

<p>Though <code>responseType</code> allows developers to, say, handle image data as a byte array instead of a binary string, it does not work miracles. Changing <code>document</code> to <code>json</code> in the example above would cause our response property to be <code>null</code> because XML is not JSON. Similarly, invalid JSON data will also cause <code>response</code> to be <code>null</code>. When setting a <code>responseType</code>, you still need to ensure that your data is both valid and compatible with the specified type.</p>

<p class="note">Note: As of publication, Opera does not support <code>blob</code> as a value, and only supports XML and not HTML for the <code>document</code> type. Chrome and Safari do not yet support <code>json</code> as a value.</p>



<h2 id="conclusion">Learn more</h2>

<p>These XMLHttpRequest improvements are a leap forward for client-side interactivity. For more on XMLHttpRequest, CORS, and related APIs, see the following resources:</p>

<ul>
  <li><a href="http://dvcs.w3.org/hg/xhr/raw-file/tip/Overview.html">XMLHttpRequest specification</a></li>
  <li><a href="../dom-access-control-using-cross-origin-resource-sharing/index.html">DOM access control using cross-origin resource sharing</a></li>
  <li><a href="../the-w3c-file-api/index.html">The W3C file API</a> by Bruce Lawson</li>
  <li><a href="http://msdn.microsoft.com/en-us/library/cc288060%28v=vs.85%29.aspx">XDomainRequest Object</a> (Internet Explorer 8 &amp; 9)</li>
</ul>

<p class="note">Note: Cover image — <q>Ajax and Achilles Gaming</q> — by <a href="http://www.flickr.com/photos/clairity/3229586543/">Sharon Mollerus</a>.</p>

      <section id="author-info">
        <h1><a href="../../../author/webinista.html" rel="author">Tiffany Brown</a></h1>
        <a href="../../../author/webinista.html" rel="author"><img src="../../../../../https/static.myopera.com/avatars/pool1/0f/7d4/0b00e2e678d97b573d91a4c6a8e06f96139." alt=""/></a>
        <p>Tiffany B. Brown is a freelance web developer based in Los Angeles. </p>
        <br class="clear" />
      </section>
      <p id="license" class="info">This article is licensed under a <a href="http://creativecommons.org/licenses/by/3.0/" rel="license">Creative Commons Attribution 3.0 Unported</a> license.</p>

    </article>
<section id="comments">
  <h2>Comments</h2>
  <ul>
    <li id="comment-95536252">
      <a href="../../../author/BS-Harou.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/c1/46f/df94bcd78dce64f1c98ea96f7b702a39626.png" alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/BS-Harou.html">Martin Kadlec</a></p>
      <p class="commentdate">Wednesday, August 29, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>I&#39;ve discovered reproducible crash with XHR2. Steps to reproduce:<br/>- Open: <a href="../../../../devfiles.myopera.com/articles/9482/xhr-responsetype.html" target="_blank">http://dev.opera.com/articles/view/xhr2/xhr-responsetype.html</a><br/>- Press CTRL+U to display source code<br/>- Replace content of onLoadHandler to:<br/>function(event){<br/> var xhr = event.target,<br/> alert(xhr.response);<br/>}<br/><br/>- Press &quot;Apply Changes&quot;<br/>- BAM! crash :(<br/><br/>I sent a crash report (email: harou2 at gmail . com)</section>
    </li>
    <li id="comment-95538142">
      <a href="../../../author/chrismills.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/49/546/4272683e28ab456dc962e131580e44990be.jpg" alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/chrismills.html">Chris Mills</a></p>
      <p class="commentdate">Wednesday, August 29, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>Nice one Martin - we&#39;ll look at it asap.</section>
    </li>
    <li id="comment-95823962">
      <a href="../../../author/BS-Harou.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/c1/46f/df94bcd78dce64f1c98ea96f7b702a39626.png" alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/BS-Harou.html">Martin Kadlec</a></p>
      <p class="commentdate">Monday, September 3, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>It seems there are more issues with the &quot;document&quot; response type in Opera. Firstly, html5test.com does not detect it. In my own tests it often returns just &quot;null&quot; even if I load valid document.</section>
    </li>
    <li id="comment-96081222">
      <a href="../../../author/mechonomics.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/0d/fb4/3eb89399db163f1c3f0d0e1640fd051d530." alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/mechonomics.html">mechonomics</a></p>
      <p class="commentdate">Saturday, September 8, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>Opera (12.02) seems to report values ~ 180% too high for progressEvent.loaded.<br/><br/>Try this and see what I mean:<br/><br/>   var xhr = new XMLHttpRequest();<br/>   var url = YOUR_URL + Math.random();<br/>   <br/>   xhr.addEventListener(&quot;progress&quot;, function(evt) {<br/>       console.log(&quot;Download progress event: &quot; + evt.loaded + &quot; Total: &quot; + evt.total + &quot; Percentage: &quot; + evt.loaded/evt.total*100);<br/>   });<br/>   <br/>   xhr.open(&quot;get&quot;, url);<br/>   xhr.send();</section>
    </li>
    <li id="comment-96106642">
      <a href="../../../author/termi1uc1.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/98/ab5/0f14096fa521cf5472767f959b970869617.jpg" alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/termi1uc1.html">Егор</a></p>
      <p class="commentdate">Sunday, September 9, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>Does Opera support only XML in xhr.responseType = &#39;document&#39; ?<br/>- Open: <a href="../../../../devfiles.myopera.com/articles/9482/xhr-responsetype.html" target="_blank">http://dev.opera.com/articles/view/xhr2/xhr-responsetype.html</a><br/>- Run in console:<br/>xhr = new XMLHttpRequest();<br/>xhr.open(&quot;GET&quot;,&quot;<a href="../../../../devfiles.myopera.com/articles/9482/xhr-responsetype.html" target="_blank">http://devfiles.myopera.com/articles/9482/xhr-responsetype.html</a>&quot;, true);<br/>xhr.responseType = &quot;document&quot;;<br/>xhr.onload = function(e){ console.log(e.type, &quot;loaded: &quot; + e.loaded, &quot;response: &quot;, this.response) };<br/>xhr.send();<br/><br/>and got<br/>&gt; load, loaded: 3654, response: , null<br/><br/>This is really oddly. Chrome and FF supported html files in xhr.response. And even worse Opera raise exception when I try to access to xhr.responseText</section>
    </li>
    <li id="comment-96678012">
      <a href="../../../author/webinista.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/0f/7d4/0b00e2e678d97b573d91a4c6a8e06f96139." alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/webinista.html">Tiffany Brown</a></p>
      <p class="commentdate">Tuesday, September 18, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>Apologies that we&#39;ve taken so long to respond to your question Erop. Yes, that is currently the case. If you are sending HTML, however, you don&#39;t really need to set the responseType property. That&#39;s how XHR has typically worked.<br/><br/>I have, however, filed a bug report for that, since it could become a site-compatibility issue. Thank you for mentioning it.</section>
    </li>
    <li id="comment-96728302">
      <a href="../../../author/mechonomics.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/0d/fb4/3eb89399db163f1c3f0d0e1640fd051d530." alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/mechonomics.html">mechonomics</a></p>
      <p class="commentdate">Wednesday, September 19, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>So, any response as to why XMLHttpRequest progressevent loaded values are far too high? It&#39;s possible for a progress event loaded to be larger than a progress event total, which should never be the case.</section>
    </li>
    <li id="comment-96990242">
      <a href="../../../author/BS-Harou.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/c1/46f/df94bcd78dce64f1c98ea96f7b702a39626.png" alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/BS-Harou.html">Martin Kadlec</a></p>
      <p class="commentdate">Monday, September 24, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>mechonomics: I believe it is caused by wrong value in Content-length header. I&#39;m not sure if other browser has some kind of algorithm to prevent the problem. </section>
    </li>
    <li id="comment-97129152">
      <a href="../../../author/mechonomics.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/0d/fb4/3eb89399db163f1c3f0d0e1640fd051d530." alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/mechonomics.html">mechonomics</a></p>
      <p class="commentdate">Wednesday, September 26, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>Martin, I don&#39;t think that&#39;s the problem because progressevent.total still reports the correct value.</section>
    </li>
    <li id="comment-97628802">
      <a href="../../../author/Bozzeye.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/af/e3a/b93cd06c45f032bf0e88bc07424e4934eeb." alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/Bozzeye.html">Bozzeye</a></p>
      <p class="commentdate">Saturday, October 6, 2012</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>When I try to run the code in the article in an extension&#39;s injected script, I get this from Dragonfly:<br/><br/>Unhandled Error: Undefined variable: XMLHttpRequest</section>
    </li>
    <li id="comment-103505942">
      <a href="../../../author/mehuge.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/b2/f5b/d2fa5ae4407ca503aa77e4bec1d7285ad5a." alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/mehuge.html">mehuge</a></p>
      <p class="commentdate">Wednesday, February 6, 2013</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>In your timeouts demo, the version with timeout support is arguably a better experience for the user because the data arrives in 5 seconds instead of 8.  <br/><br/>Aborting and retrying is undesirable because if data was arriving just taking a long time, then you have just thrown away your hard work, all just so you can guess the right length of timeout to use.  <br/><br/>What you need to do is keep increasing the timeout whilst data is arriving, keeping it just far enough ahead to allow for a slow connection whilst at the same time detecting a failure condition.<br/><br/><a href="http://code.google.com/p/xhr-progressive-timeouts/" target="_blank">http://code.google.com/p/xhr-progressive-timeouts/</a> does just that, it maintains a short timeout but allows long requests to complete without interrupting them, so no wasted processing.</section>
    </li>
    <li id="comment-105266802">
      <a href="../../../author/rvmaksim.html"><img src="../../../../../https/static.myopera.com/avatars/pool1/0c/f09/f433fdad3b32457db3b5144926333478f37.jpg" alt="photo" class="avatar"/></a>
      <p class="commenter"><a href="../../../author/rvmaksim.html">rvmaksim</a></p>
      <p class="commentdate">Monday, March 18, 2013</p>
      <section class="commentcontent"><span class="bubble-arrow"></span>Good day! <br/>Have a problem with HTTPS and upload.onprogress event. When we upload file throught https event progress doesn&#39;t fire.<br/><br/>You can confirm this replace in demo(<a href="../../../../devfiles.myopera.com/articles/9482/xhr-progressevents.html" target="_blank">http://dev.opera.com/articles/view/xhr2/xhr-progressevents.html</a>) http on https:<br/>&gt;&gt;&gt; var makeHttpsRequest = eval(makeRequest.toString().replace(/http/g,&#39;https&#39;));<br/>&gt;&gt;&gt; document.querySelector(&#39;form&#39;).removeEventListener(&#39;submit&#39;, makeRequest, false);<br/>&gt;&gt;&gt; document.querySelector(&#39;form&#39;).addEventListener(&#39;submit&#39;, makeHttpsRequest, false);<br/><br/>Is there a solution to this problem?<br/>Thanks!</section>
    </li>
  </ul>
No new comments accepted.
</section>

  </section>

  <aside>
    <section class="info">
      <p class="author"><strong>Author</strong> <a href="../../../author/webinista.html" rel="author">Tiffany Brown</a></p>
      <p>
        <strong>Date</strong>
        Wednesday, August 29, 2012
      </p>

      <p class="tags"><strong>Tags</strong></p>
      <ul class="tags">
        <li><a href="../../tags/ajax.html" rel="tag">ajax</a></li>
        <li><a href="../../tags/request.html" rel="tag">request</a></li>
        <li><a href="../../tags/response.html" rel="tag">response</a></li>
        <li><a href="../../tags/xhr.html" rel="tag">xhr</a></li>
        <li><a href="../../tags/xhr2.html" rel="tag">xhr2</a></li>
        <li><a href="../../tags/xmlhttprequest.html" rel="tag">xmlhttprequest</a></li>
      </ul>
    </section>
  </aside>




</section>
<script type="text/javascript" src="../../../../static.myopera.com/dev/js/highlight.pack.js"></script>
<script type="text/javascript">hljs.initHighlightingOnLoad();</script>

    <footer>
      <section role="contentinfo">
        <ul>
          <li><a href="../../../help.html">Help/<abbr>FAQ</abbr></a>
          <li><a href="http://my.opera.com/community/terms-of-service/?utm_source=devopera&amp;utm_medium=footer&amp;utm_campaign=devlinks">Terms of service</a>
          <li><a href="../../../privacy.html">Privacy</a>
        </ul>
      </section>
    </footer>
  </body>
</html>
